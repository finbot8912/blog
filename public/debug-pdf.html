<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF ë””ë²„ê·¸ ë„êµ¬</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #0f0;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 { color: #0ff; border-bottom: 2px solid #0ff; padding-bottom: 10px; }
        h2 { color: #ff0; margin-top: 30px; }
        button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px 5px;
            border-radius: 5px;
        }
        button:hover { background: #0ff; }
        .output {
            background: #1a1a1a;
            border: 2px solid #333;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 500px;
            overflow-y: auto;
        }
        .success { color: #0f0; }
        .error { color: #f00; }
        .warning { color: #ff0; }
        .info { color: #0ff; }
    </style>
</head>
<body>
    <h1>ğŸ”§ PDF ë””ë²„ê·¸ ë„êµ¬</h1>
    
    <h2>Step 1: PDF íŒŒì¼ ì ‘ê·¼ í…ŒìŠ¤íŠ¸</h2>
    <button onclick="testPdfAccess()">ì‹¤í–‰</button>
    <div id="step1" class="output">ëŒ€ê¸° ì¤‘...</div>

    <h2>Step 2: PDF ì „ì²´ í…ìŠ¤íŠ¸ ì¶”ì¶œ</h2>
    <button onclick="testPdfExtraction()">ì‹¤í–‰</button>
    <div id="step2" class="output">ëŒ€ê¸° ì¤‘...</div>

    <h2>Step 3: í‚¤ì›Œë“œ ê²€ìƒ‰ í…ŒìŠ¤íŠ¸</h2>
    <input type="text" id="search-keyword" value="ë¯¸ë…¹ì‹œë”œ" style="background: #000; color: #0f0; border: 2px solid #0f0; padding: 10px; width: 300px;">
    <button onclick="testKeywordSearch()">ê²€ìƒ‰</button>
    <div id="step3" class="output">ëŒ€ê¸° ì¤‘...</div>

    <h2>Step 4: ì™„ì „ í†µí•© í…ŒìŠ¤íŠ¸</h2>
    <input type="text" id="test-topic" value="ë¯¸ë…¹ì‹œë”œ íš¨ê³¼ì™€ ë¶€ì‘ìš©" style="background: #000; color: #0f0; border: 2px solid #0f0; padding: 10px; width: 400px;">
    <button onclick="testFullIntegration()">ì „ì²´ í…ŒìŠ¤íŠ¸</button>
    <div id="step4" class="output">ëŒ€ê¸° ì¤‘...</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let cachedPdf = null;
        let cachedText = null;

        async function testPdfAccess() {
            const output = document.getElementById('step1');
            output.innerHTML = '<span class="info">í…ŒìŠ¤íŠ¸ ì¤‘...</span>';
            
            try {
                const response = await fetch('/book.pdf');
                if (response.ok) {
                    const blob = await response.blob();
                    output.innerHTML = `<span class="success">âœ… ì„±ê³µ!</span>
Status: ${response.status}
Size: ${blob.size} bytes (${(blob.size / 1024).toFixed(2)} KB)
Type: ${blob.type}`;
                } else {
                    output.innerHTML = `<span class="error">âŒ ì‹¤íŒ¨!</span>
Status: ${response.status} ${response.statusText}`;
                }
            } catch (error) {
                output.innerHTML = `<span class="error">âŒ ì˜¤ë¥˜!</span>
${error.message}`;
            }
        }

        async function testPdfExtraction() {
            const output = document.getElementById('step2');
            output.innerHTML = '<span class="info">PDF ë¡œë“œ ì¤‘...</span>';
            
            try {
                const loadingTask = pdfjsLib.getDocument('/book.pdf');
                const pdf = await loadingTask.promise;
                cachedPdf = pdf;
                
                output.innerHTML = `<span class="info">ì´ ${pdf.numPages} í˜ì´ì§€ í…ìŠ¤íŠ¸ ì¶”ì¶œ ì¤‘...</span>`;
                
                let fullText = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += `[í˜ì´ì§€ ${i}]\\n${pageText}\\n\\n`;
                }
                
                cachedText = fullText;
                
                output.innerHTML = `<span class="success">âœ… ì¶”ì¶œ ì™„ë£Œ!</span>
ì´ í˜ì´ì§€: ${pdf.numPages}
ì „ì²´ í…ìŠ¤íŠ¸ ê¸¸ì´: ${fullText.length} ì

ì²« 1000ì ë¯¸ë¦¬ë³´ê¸°:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
${fullText.substring(0, 1000)}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`;
            } catch (error) {
                output.innerHTML = `<span class="error">âŒ ì˜¤ë¥˜!</span>
${error.message}
${error.stack}`;
            }
        }

        async function testKeywordSearch() {
            const output = document.getElementById('step3');
            const keyword = document.getElementById('search-keyword').value;
            
            if (!cachedText) {
                output.innerHTML = '<span class="warning">âš ï¸ ë¨¼ì € Step 2ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”!</span>';
                return;
            }
            
            output.innerHTML = `<span class="info">í‚¤ì›Œë“œ "${keyword}" ê²€ìƒ‰ ì¤‘...</span>`;
            
            const lines = cachedText.split('\\n');
            const matches = [];
            
            lines.forEach((line, index) => {
                if (line.toLowerCase().includes(keyword.toLowerCase())) {
                    matches.push({ line: index + 1, text: line });
                }
            });
            
            if (matches.length > 0) {
                output.innerHTML = `<span class="success">âœ… ${matches.length}ê°œ ë§¤ì¹­ ë°œê²¬!</span>

ë§¤ì¹­ëœ ë¼ì¸ë“¤ (ìµœëŒ€ 20ê°œ):
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
${matches.slice(0, 20).map(m => `ë¼ì¸ ${m.line}: ${m.text.substring(0, 200)}`).join('\\n\\n')}`;
            } else {
                output.innerHTML = `<span class="warning">âš ï¸ í‚¤ì›Œë“œ "${keyword}"ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</span>`;
            }
        }

        async function testFullIntegration() {
            const output = document.getElementById('step4');
            const topic = document.getElementById('test-topic').value;
            
            output.innerHTML = '<span class="info">í†µí•© í…ŒìŠ¤íŠ¸ ì‹œì‘...</span>';
            
            try {
                // 1. í‚¤ì›Œë“œ ê°ì§€
                const hairLossKeywords = ['íƒˆëª¨', 'ëª¨ë°œ', 'ë‘í”¼', 'í—¤ì–´', 'ë¯¸ë…¹ì‹œë”œ', 'í”¼ë‚˜ìŠ¤í…Œë¦¬ë“œ'];
                const isHairLoss = hairLossKeywords.some(k => topic.toLowerCase().includes(k.toLowerCase()));
                
                let log = `<span class="info">ì£¼ì œ: ${topic}</span>\\n`;
                log += `<span class="${isHairLoss ? 'success' : 'warning'}">íƒˆëª¨ ê´€ë ¨: ${isHairLoss ? 'âœ… YES' : 'âŒ NO'}</span>\\n\\n`;
                
                if (!isHairLoss) {
                    output.innerHTML = log + '<span class="warning">íƒˆëª¨ ê´€ë ¨ ì£¼ì œê°€ ì•„ë‹™ë‹ˆë‹¤.</span>';
                    return;
                }
                
                // 2. í‚¤ì›Œë“œ ì¶”ì¶œ
                const stopWords = ['ì˜', 'ê°€', 'ì´', 'ì€', 'ëŠ”', 'ì„', 'ë¥¼', 'ì—', 'ì™€', 'ê³¼', 'ë¡œ', 'ìœ¼ë¡œ'];
                const words = topic.split(/[\\s,]+/).filter(w => w.length >= 2 && !stopWords.includes(w));
                const allKeywords = [...new Set([...words, 'íƒˆëª¨', 'ëª¨ë°œ', 'ë‘í”¼', 'ì¹˜ë£Œ', 'ì•½ë¬¼', 'íš¨ê³¼', 'ë¶€ì‘ìš©'])];
                
                log += `<span class="info">ì¶”ì¶œ í‚¤ì›Œë“œ: ${allKeywords.join(', ')}</span>\\n\\n`;
                
                // 3. PDF ë¡œë“œ ë° ê²€ìƒ‰
                log += '<span class="info">PDF ë¡œë“œ ì¤‘...</span>\\n';
                output.innerHTML = log;
                
                const loadingTask = pdfjsLib.getDocument('/book.pdf');
                const pdf = await loadingTask.promise;
                
                log += `<span class="success">âœ… PDF ë¡œë“œ ì™„ë£Œ! (${pdf.numPages} í˜ì´ì§€)</span>\\n\\n`;
                
                const relevantPages = [];
                
                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                    const page = await pdf.getPage(pageNum);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    
                    let score = 0;
                    for (const keyword of allKeywords) {
                        const regex = new RegExp(keyword, 'gi');
                        const matches = pageText.match(regex);
                        if (matches) score += matches.length;
                    }
                    
                    if (score > 0) {
                        relevantPages.push({ pageNum, text: pageText, score });
                        log += `<span class="success">í˜ì´ì§€ ${pageNum}: ì ìˆ˜ ${score}</span>\\n`;
                        output.innerHTML = log;
                    }
                }
                
                relevantPages.sort((a, b) => b.score - a.score);
                
                log += `\\n<span class="success">âœ… ê²€ìƒ‰ ì™„ë£Œ! ${relevantPages.length}ê°œ í˜ì´ì§€ ë°œê²¬</span>\\n\\n`;
                
                if (relevantPages.length > 0) {
                    let combinedText = '';
                    const pageNumbers = [];
                    
                    for (const item of relevantPages.slice(0, 5)) {
                        combinedText += `[í˜ì´ì§€ ${item.pageNum}]\\n${item.text}\\n\\n`;
                        pageNumbers.push(item.pageNum);
                    }
                    
                    log += `<span class="info">ì¶”ì¶œ í…ìŠ¤íŠ¸ ê¸¸ì´: ${combinedText.length}ì</span>\\n`;
                    log += `<span class="info">ì°¸ì¡° í˜ì´ì§€: ${pageNumbers.join(', ')}</span>\\n\\n`;
                    log += `<span class="success">â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”</span>\\n`;
                    log += `<span class="success">ë‚´ìš© ë¯¸ë¦¬ë³´ê¸° (ì²« 1000ì):</span>\\n`;
                    log += `<span class="info">${combinedText.substring(0, 1000)}</span>\\n`;
                    log += `<span class="success">â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”</span>\\n`;
                } else {
                    log += '<span class="warning">âš ï¸ ê´€ë ¨ í˜ì´ì§€ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</span>\\n';
                }
                
                output.innerHTML = log;
                
            } catch (error) {
                output.innerHTML = `<span class="error">âŒ ì˜¤ë¥˜ ë°œìƒ!</span>\\n${error.message}\\n\\n${error.stack}`;
            }
        }
    </script>
</body>
</html>

